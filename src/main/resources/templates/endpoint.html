<!DOCTYPE html>
<html lang="en">
<head>
</head>
<body>
<script>
    var endpointData;

    function getEndpointRequestForm(type, path) {
        var endpointFormWindow = isc.Window.create({
            isModal: true,
            showModalMask: true,
            autoDraw: false,
            autoSize: true,
            canDragReposition: true,
            canDragResize: true,
            autoCenter: true,
            items: [
                isc.DynamicForm.create({
                    ID: "endpointForm",
                    numCols: 2,
                    fields: [
                        {name: "name", title: "نام"},
                        {name: "url", title: "آدرس"},
                        {name: "curl", title: "curl", type: "textArea", height: "200"},
                        {name: "testEnv", title: "محیط تستی", type: "boolean"},
                        {name: "prodEnv", title: "محیط عملیاتی", type: "boolean"},
                        {name: "description", title: "توضیحات"}
                    ]
                }),
                isc.HStack.create({
                    height: 30,
                    width: "100%",
                    layoutMargin: 10,
                    members: [
                        isc.Label.create({
                            contents: "ذخیره",
                            showShadow: true,
                            shadowDepth: 5,
                            border: "1px solid #cdffe1",
                            backgroundColor: "#f3f3f3",
                            align: "center",
                            icon: "[SKIN]/actions/add.png",
                            iconOrientation: "right",
                            click: function () {
                                if (endpointForm.validate())
                                    isc.RPCManager.sendRequest({
                                        actionURL: baseUrl + path,
                                        httpMethod: "POST",
                                        contentType: "application/json",
                                        useSimpleHttp: true,
                                        showPrompt: false,
                                        useStrictJSON: true,
                                        data: JSON.stringify(endpointForm.values),
                                        callback: function (data, response) {
                                            endpointFormWindow.close();
                                            endpointData = JSON.parse(response);
                                            endpointGrid.setData(endpointData);
                                            endpointGrid.fetchData();
                                            isc.say("درخواست با موفقیت انجام شد.")
                                        }
                                    })
                            }
                        })
                    ]
                })
            ]
        });
        if (type == "edit") {
            endpointFormWindow.setTitle("فرم ویرایش");
            endpointForm.setValues(endpointGrid.getSelectedRecord())
        } else {
            endpointFormWindow.setTitle("فرم ایجاد");
        }
        endpointFormWindow.show();
    }

    isc.ToolStrip.create({
        ID: "endpointGridEditControls",
        width: "100%", height: 24,
        members: [
            isc.ToolStripButton.create({
                icon: "[SKIN]/actions/add.png",
                prompt: "افزودن رکورد جدید",
                click: function () {
                    getEndpointRequestForm("add", addEndpoint)
                }
            }),
            isc.ToolStripButton.create({
                icon: "[SKIN]/actions/edit.png",
                prompt: "ویرایش رکورد انتخاب شده",
                click: function () {
                    var record = endpointGrid.getSelectedRecord();
                    if (record == null) return;
                    getEndpointRequestForm("edit", editEndpoint)
                }
            }),
            isc.ToolStripButton.create({
                icon: "[SKIN]/actions/remove.png",
                prompt: "حذف رکورد انتخاب شده",
                click: function () {
                    isc.ask("آیا از حذف رکورد اطمینان دارید؟", function (ans) {
                        if (ans) {
                            var id = endpointGrid.getSelectedRecord().id;
                            isc.RPCManager.sendRequest({
                                actionURL: baseUrl + deleteEndpoint + id,
                                httpMethod: "DELETE",
                                contentType: "application/json",
                                useSimpleHttp: true,
                                showPrompt: false,
                                useStrictJSON: true,
                                callback: function (data, response) {
                                    endpointData = JSON.parse(response);
                                    endpointGrid.setData(endpointData);
                                    endpointGrid.fetchData();
                                    isc.say("درخواست با موفقیت انجام شد.")
                                }
                            })
                        }
                    })
                }
            }),
            isc.LayoutSpacer.create({width: "*"})
        ]
    });
    isc.VLayout.create({
        ID: "endpointLayout",
        showEdges: false,
        height: "100%",
        width: "100%",
        membersMargin: 5, layoutMargin: 10,
        members: [
            isc.Label.create({
                ID: "endpointLabel",
                contents: "لیست سرویس ها",
                width: "100%",
                height: "10%",
                align: "center",
                showShadow: true,
            }),
            isc.ListGrid.create({
                ID: "endpointGrid",
                width: "100%",
                height: "90%",
                gridComponents: ["header", "filterEditor", "body", endpointGridEditControls],
                showResizeBar: true,
                canDragSelectText: true,
                showFilterEditor: false,
                wrapCells: true,
                fixedRecordHeights: false,
                fields: [
                    {name: "name", title: "نام"},
                    {name: "url", title: "آدرس"},
                    {name: "curl", title: "curl"},
                    {name: "testEnv", title: "محیط تستی", type: "boolean", width: "100"},
                    {name: "prodEnv", title: "محیط عملیاتی", type: "boolean", width: "100"},
                    {name: "description", title: "توضیحات"},
                ],
                canReorderFields: true,
                showRollOverCanvas: true,
                showRollUnderCanvas: true, // disable the rollUnderCanvas because we're not using it
                rollOverCanvasConstructor: isc.HLayout,
                rollOverCanvasProperties: {
                    snapTo: "L", height: 20, width: 70,
                    members: [
                        {
                            _constructor: "Button", title: "شرکت ها",
                            click: function (){showEndpointCompaniesWindow(this.parentElement.record)},
                            height: 20, width: "100%"
                        }
                    ]
                }
            })
        ]
    });
    isc.RPCManager.sendRequest({
        actionURL: baseUrl + allEndpoint,
        httpMethod: "GET",
        callback: function (data, response) {
            endpointData = JSON.parse(response);
            endpointGrid.setData(endpointData);
            endpointGrid.fetchData();

        }
    });

    function showEndpointCompaniesWindow(record) {
        var endpointFormWindow = isc.Window.create({
            isModal: true,
            showModalMask: true,
            autoDraw: false,
            autoSize: true,
            canDragReposition: true,
            canDragResize: true,
            autoCenter: true,
            items: []
        })
    }

</script>
</body>
</html>
