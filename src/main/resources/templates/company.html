<?xml version="1.0" encoding="UTF-8"?>
<html lang="en">
<head>
</head>
<body>
<script>
    var companyFormWindow = isc.Window.create({
        width: "30%",
        height: "30%",
        isModal: true,
        showModalMask: true,
        autoDraw: false,
        title: "فرم ایجاد/ویرایش شرکت",
        autoSize: true,
        canDragReposition: true,
        canDragResize: true,
        autoCenter: true,
        items:[
            isc.DynamicForm.create({
                ID: "companyForm",
                numCols: 4,
                fields: [
                    {name: "name", title: "نام", required:true},
                    {name: "userName", title: "نام کاربری"},
                    {name: "ip", title: "ip"},
                    {name: "phone", title: "شماره تماس"},
                    {name: "description", title: "توضیحات"}
                ]
            }),
            isc.IButton.create({
                title: "ذخیره",
                icon: "icons/16/world.png",
                iconOrientation: "right",
                click: function () {
                    if(companyForm.validate())
                    isc.RPCManager.sendRequest({
                        actionURL: "http://localhost:4100/companies/save",
                        httpMethod: "POST",
                        // contentType: "application/json",
                        contentType:"application/json",
                        useSimpleHttp:true,
                        showPrompt:false,
                        useStrictJSON:true,
                        data:JSON.stringify(companyForm.values),
                        callback: function (data, response) {
                            companyFormWindow.close();
                            companyData= JSON.parse(response);
                            companyGrid.setData(companyData);
                            companyGrid.fetchData();
                        }
                    })
                }
            })
        ]
    });

    isc.ToolStrip.create({
        ID: "companyGridEditControls",
        width: "100%", height:24,
        members: [
            isc.ToolStripButton.create({
                icon: "[SKIN]/actions/add.png",
                prompt: "افزودن رکورد جدید",
                click: function () {
                    companyFormWindow.show();
                    /*var record = countryList.getSelectedRecord();
                    if (record == null) return;
                    countryList.startEditing(countryList.data.indexOf(record));*/
                }
            }),
            isc.ToolStripButton.create({
                icon: "[SKIN]/actions/edit.png",
                prompt: "ویرایش رکورد انتخاب شده",
                click: function () {
                    var record = countryList.getSelectedRecord();
                    if (record == null) return;
                    countryList.startEditing(countryList.data.indexOf(record));
                }
            }),
            isc.ToolStripButton.create({
                icon: "[SKIN]/actions/remove.png",
                prompt: "حذف رکورد انتخاب شده",
                click: "countryList.removeSelectedData()"
            }),
            isc.LayoutSpacer.create({ width:"*" })
        ]
    });
    var companyData ;
    var endpointData;

    isc.VLayout.create({
        ID:"companyLayout",
        showEdges:false,
        height:"100%",
        width:"100%",
        membersMargin:5,  layoutMargin:10,
        members:[
            isc.HLayout.create({
                showEdges: false,
                width: "100%",
                height: "10%", membersMargin: 5, layoutMargin: 10,
                members: [
                    isc.Label.create({
                        ID: "companyLabel",
                        contents: "لیست شرکت ها",
                        width: "50%",
                        height: "100%",
                        align: "center",
                        backgroundColor:"#e8cdff",
                        showShadow: false,
                    }),
                    isc.Label.create({
                        ID: "companyEndpointsLabel",
                        contents: "لیست سرویس های ارائه شده به شرکت ",
                        width: "50%",
                        height: "100%",
                        align: "center",
                        backgroundColor:"#cdfffa",
                        showShadow: false,
                    })
                ]
            }),
            isc.HLayout.create({
                showEdges:false,
                width: "100%",
                height: "90%", membersMargin:5,  layoutMargin:10,
                members:[
                    isc.ListGrid.create({
                        ID: "companyGrid",
                        width: "50%",
                        height: "100%",
                        alternateRecordStyles: true,
                        showResizeBar: true,
                        gridComponents:["header", "filterEditor", "body", companyGridEditControls],
                        // data: companyData,
                        recordClick(viewer, record, recordNum, field, fieldNum, value, rawValue) {
                            var company = record.id;
                            isc.RPCManager.sendRequest({
                                actionURL: "http://localhost:4100/endpoints-by-company?companyId="+company,
                                httpMethod: "GET",
                                callback: function (data, response) {
                                    endpointData= JSON.parse(response);
                                    endpointGrid.setData(endpointData);
                                    endpointGrid.fetchData();

                                }
                            });
                        },
                        fields: [
                            {name: "name", title: "نام"},
                            {name: "userName", title: "نام کاربری"},
                            {name: "ip", title: "ip"},
                            {name: "phone", title: "شماره تماس"},
                            {name: "description", title: "توضیحات"}
                        ],
                        canReorderFields: true
                    }),
                    isc.ListGrid.create({
                        ID: "endpointGrid",
                        width: "50%",
                        height: "100%",
                        alternateRecordStyles: true,
                        showResizeBar: true,
                        // data: endpointData,
                        autoFetchData: false,
                        canDragSelectText:true,
                        showFilterEditor: false,
                        showRollOver:false,
                        wrapCells: true,
                        fixedRecordHeights: false,
                        fields: [
                            {name: "name", title: "نام"},
                            {name: "url", title: "آدرس"},
                            {name: "curl", title: "curl"},
                            {name: "description", title: "توضیحات"},
                        ],
                        canReorderFields: true
                    })
                ]
            })

        ]
    });

    isc.RPCManager.sendRequest({
        actionURL: "http://localhost:4100/companies/",
        httpMethod: "GET",
        callback: function (data, response) {
            companyData= JSON.parse(response);
            companyGrid.setData(companyData);
            companyGrid.fetchData();

        }
    });

</script>
</body>
</html>
